---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

interface SlideData {
  quote: string;
  author: string;
  title: string;
  photo: string;
}

interface Props {
  data: SlideData[];
}

const { data } = Astro.props;

// Glob all images in endorsements folder
const images = import.meta.glob<{ default: ImageMetadata }>(
  "../assets/img/endorsements/*.{jpeg,jpg,png,gif,webp}",
);

const slides = await Promise.all(
  data.map(async (item) => {
    const filename = item.photo.split("/").pop();
    // Construct the key as expected by the glob (relative to this component)
    const globKey = `../assets/img/endorsements/${filename}`;

    if (!images[globKey]) {
      console.warn(
        `Carousel Image matched no key: ${globKey}. Keys: ${Object.keys(images).join(", ")}`,
      );
      return { ...item, imageMeta: null };
    }

    const imgModule = await images[globKey]();
    return { ...item, imageMeta: imgModule.default };
  }),
);
---

<div
  class="carousel-container relative w-full max-w-[1000px] mx-auto overflow-hidden bg-primary-blue text-white group"
  aria-label="Testimonials Carousel"
>
  <div
    class="carousel-track flex transition-transform duration-700 ease-in-out h-full"
    id="track"
  >
    {
      slides.map((slide, index) => (
        <div
          class="carousel-item min-w-full relative flex flex-col md:flex-row h-auto md:h-[600px]"
          data-index={index}
        >
          <div class="w-full md:w-[30%] h-[400px] md:h-full relative overflow-hidden">
            {slide.imageMeta ? (
              <Image
                src={slide.imageMeta}
                alt={slide.author}
                class="absolute inset-0 w-full h-full object-cover"
                width={800}
                quality={90}
              />
            ) : (
              <div class="w-full h-full bg-gray-300 flex items-center justify-center text-gray-500">
                Image not found
              </div>
            )}
          </div>
          <div class="w-full md:w-[70%] p-8 md:p-16 flex flex-col justify-center bg-primary-blue text-white">
            <blockquote class="text-base md:text-lg lg:text-xl font-light mb-6 leading-snug italic opacity-95">
              "{slide.quote}"
            </blockquote>
            <div class="mt-2">
              <p class="text-lg font-bold tracking-wide">{slide.author}</p>
              <p class="text-base opacity-80">{slide.title}</p>
            </div>
          </div>
        </div>
      ))
    }
  </div>

  <!-- Indicators -->
  <div
    class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-3 z-10 bg-black/20 px-4 py-2 rounded-full"
  >
    {
      slides.map((_, i) => (
        <button
          class={`w-2 h-2 rounded-full transition-all duration-300 indicator ${i === 0 ? "bg-white scale-125" : "bg-white/50 hover:bg-white/80"}`}
          data-index={i}
          aria-label={`Go to slide ${i + 1}`}
        />
      ))
    }
  </div>

  <!-- Arrows -->
  <button
    class="absolute top-[400px] md:top-1/2 left-4 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white p-3 rounded-full transition-colors prev-btn"
    aria-label="Previous Slide"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="2"
      stroke="currentColor"
      class="w-6 h-6"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M15.75 19.5L8.25 12l7.5-7.5"></path>
    </svg>
  </button>
  <button
    class="absolute top-[400px] md:top-1/2 right-4 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white p-3 rounded-full transition-colors next-btn"
    aria-label="Next Slide"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="2"
      stroke="currentColor"
      class="w-6 h-6"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M8.25 4.5l7.5 7.5-7.5 7.5"></path>
    </svg>
  </button>
</div>

<script>
  function initCarousel() {
    const track = document.getElementById("track");
    const items = document.querySelectorAll(".carousel-item");
    const indicators = document.querySelectorAll(".indicator");
    const prevBtn = document.querySelector(".prev-btn");
    const nextBtn = document.querySelector(".next-btn");

    if (!track || items.length === 0) return;

    let currentIndex = 0;
    const totalSlides = items.length;
    let autoplayInterval: any;

    const updateSlide = (index: number) => {
      currentIndex = (index + totalSlides) % totalSlides;
      const offset = currentIndex * -100;
      track.style.transform = `translateX(${offset}%)`;

      // Update indicators
      indicators.forEach((ind, i) => {
        if (i === currentIndex) {
          ind.classList.remove("bg-white/50");
          ind.classList.add("bg-white", "scale-125");
        } else {
          ind.classList.add("bg-white/50");
          ind.classList.remove("bg-white", "scale-125");
        }
      });
    };

    const nextSlide = () => updateSlide(currentIndex + 1);
    const prevSlide = () => updateSlide(currentIndex - 1);

    const startAutoplay = () => {
      stopAutoplay();
      autoplayInterval = setInterval(nextSlide, 6000);
    };

    const stopAutoplay = () => {
      if (autoplayInterval) clearInterval(autoplayInterval);
    };

    // Event Listeners
    if (nextBtn)
      nextBtn.addEventListener("click", () => {
        nextSlide();
        startAutoplay();
      });

    if (prevBtn)
      prevBtn.addEventListener("click", () => {
        prevSlide();
        startAutoplay();
      });

    indicators.forEach((ind) => {
      ind.addEventListener("click", (e) => {
        const idx = parseInt(
          (e.target as HTMLElement).getAttribute("data-index") || "0",
        );
        updateSlide(idx);
        startAutoplay();
      });
    });

    // Pause on hover
    track.addEventListener("mouseenter", stopAutoplay);
    track.addEventListener("mouseleave", startAutoplay);

    // Initial start
    startAutoplay();
  }

  // Run on load and View Transitions
  document.addEventListener("astro:page-load", initCarousel);
  document.addEventListener("DOMContentLoaded", initCarousel);
</script>
